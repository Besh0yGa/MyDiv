<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التقاط صورة وإرسالها إلى ديسكورد</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;display:flex;flex-direction:column;gap:12px;align-items:center;padding:20px}
    video, img{width:320px;height:240px;border-radius:8px;background:#000;object-fit:cover}
    .controls{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
    input[type=text]{width:100%;max-width:640px}
  </style>
</head>
<body>
  <h2>التقاط صورة بالكاميرا الأمامية وإرسالها إلى ديسكورد</h2>

  <!-- ضع رابط الويب هوك هنا (احفظه سري) -->
  <label>Discord Webhook URL (احتفظ به سريًا):</label>
  <input id="webhook" type="text" placeholder="https://discord.com/api/webhooks/...." />

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240" style="display:none"></canvas>
  <img id="preview" alt="صورة المعاينة" />

  <div class="controls">
    <button id="startBtn">تشغيل الكاميرا</button>
    <button id="captureBtn" disabled>التقاط</button>
    <button id="sendBtn" disabled>إرسال إلى ديسكورد</button>
  </div>

  <p style="max-width:640px;font-size:14px;color:#555">ملاحظة: يجب استضافة الملف على HTTPS أو فتحه من <code>http://localhost</code> ليعمل الوصول إلى الكاميرا. تأكد من إدخال رابط Webhook صحيح.</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const sendBtn = document.getElementById('sendBtn');
    const webhookInput = document.getElementById('webhook');

    let backStream = null;
    let lastBlob = null;

    async function startCamera(){
      try{
        // نعرض الفيديو من الكاميرا الخلفية
        backStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = backStream;
        captureBtn.disabled = false;
      }catch(err){
        alert('فشل في الوصول إلى الكاميرا الخلفية: ' + err.message);
      }
    }

    async function capture(){
      try{
        // عند الالتقاط نطلب الكاميرا الأمامية
        const frontStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        const tempVideo = document.createElement('video');
        tempVideo.srcObject = frontStream;
        await tempVideo.play();

        const ctx = canvas.getContext('2d');
        ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
          lastBlob = blob;
          preview.src = URL.createObjectURL(blob);
          sendBtn.disabled = false;
        }, 'image/png');

        // إيقاف الكاميرا الأمامية بعد الالتقاط
        frontStream.getTracks().forEach(t => t.stop());
      }catch(err){
        alert('فشل في التقاط الكاميرا الأمامية: ' + err.message);
      }
    }

    async function sendToDiscord(){
      const webhookUrl = webhookInput.value.trim();
      if(!webhookUrl){ alert('ادخل رابط الWebhook أولاً'); return; }
      if(!lastBlob){ alert('التقط صورة أولاً'); return; }

      try{
        const form = new FormData();
        form.append('file', lastBlob, 'capture.png');

        const res = await fetch(webhookUrl, { method: 'POST', body: form });
        if(res.ok){
          alert('تم الإرسال إلى ديسكورد بنجاح');
        }else{
          const text = await res.text();
          alert('فشل الإرسال: ' + res.status + '\n' + text);
        }
      }catch(err){
        alert('خطأ أثناء الإرسال: ' + err.message);
      }
    }

    startBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', capture);
    sendBtn.addEventListener('click', sendToDiscord);

    window.addEventListener('beforeunload', () => {
      if(backStream){
        backStream.getTracks().forEach(t => t.stop());
      }
    });
  </script>
</body>
</html>
